{% load static %}
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>C4 проверка</title>
  <style>
    :root{
      --bg1:#041a3a;
      --bg2:#0b3b86;
      --card:rgba(255,255,255,0.08);
      --stroke:rgba(255,255,255,0.18);
      --text:#eaf2ff;
      --muted:rgba(234,242,255,0.72);
      --btn1:#163f89;
      --btn2:#1b5bd1;
      --btn3:#2f8cff;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 30% 10%, var(--bg2), var(--bg1));
      min-height:100vh;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:38px 26px 60px}
    h1{margin:0 0 8px;font-size:44px;letter-spacing:.5px}
    .sub{margin:0 0 22px;color:var(--muted);font-size:16px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      align-items:start;
    }
    .section-title{
      font-weight:800;
      margin:0 0 12px;
      color:rgba(234,242,255,0.9);
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,0.18);
      color:var(--text);
      background:linear-gradient(180deg, rgba(47,140,255,.32), rgba(22,63,137,.25));
      padding:12px 18px;
      border-radius:16px;
      cursor:pointer;
      font-weight:800;
      font-size:15px;
      box-shadow: 0 10px 20px rgba(0,0,0,.18) inset;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn-primary{
      background:linear-gradient(180deg, rgba(47,140,255,.85), rgba(27,91,209,.65));
      border-color:rgba(255,255,255,0.28);
    }
    .pill{
      margin-top:10px;
      padding:12px 14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.15);
      color:rgba(234,242,255,0.9);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .muted{color:var(--muted)}
    .hidden-file{display:none}
    .mode{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .mode input{display:none}
    .mode label{
      cursor:pointer;
      user-select:none;
      padding:12px 16px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.14);
      font-weight:900;
    }
    .mode input:checked + label{
      background:linear-gradient(180deg, rgba(47,140,255,.85), rgba(27,91,209,.65));
      border-color:rgba(255,255,255,0.28);
    }
    .env{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .env input{display:none}
    .env label{
      cursor:pointer;
      user-select:none;
      padding:10px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.14);
      font-weight:800;
    }
    .env input:checked + label{
      background:rgba(47,140,255,.28);
      border-color:rgba(255,255,255,0.28);
    }
    .right{
      display:flex;
      flex-direction:column;
      gap:14px;
      align-items:flex-end;
    }
    .hint{color:var(--muted);font-size:13px;line-height:1.35;max-width:360px;text-align:right}
    .out{
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid rgba(255,255,255,0.12);
    }
    .output-box{
      margin-top:10px;
      min-height:180px;
      max-height:320px;
      overflow:auto;
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.18);
      white-space:pre-wrap;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      font-size:13px;
      color:rgba(234,242,255,0.92);
    }
    .row-gap{height:10px}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>C4 проверка</h1>
    <p class="sub">Выберите режим, загрузите файл(ы) и нажмите «Старт». Внизу появится окно вывода.</p>

    <div class="card">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- hidden inputs -->
        <input id="id_drawio" class="hidden-file" type="file" name="drawio_file" accept=".drawio,.xml">
        <input id="id_excel_new" class="hidden-file" type="file" name="excel_new_file" accept=".xlsx,.xls">
        <input id="id_excel_old" class="hidden-file" type="file" name="excel_old_file" accept=".xlsx,.xls">

        <div class="grid">

          <!-- LEFT -->
          <div>
            <p class="section-title">Файлы</p>

            <!-- DIAGRAM BLOCK -->
            <div id="block-diagram">
              <button type="button" class="btn" id="btnDrawio">Загрузка drawio</button>
              <div class="pill" id="drawioName"><b>DRAWIO:</b> <span class="muted">не выбран</span></div>
              <div class="row-gap"></div>
            </div>

            <!-- SERVICES BLOCK (always visible; внутри меняется) -->
            <div id="block-services">
              <p class="section-title" style="margin-top:12px;">Проверка заказа</p>
              <div id="block-submodes">
              <!-- SUBMODE -->
                <p class="section-title" style="margin-top:10px;">Что проверяем</p>
                <div class="env" id="order-submode">
                  <input type="radio" id="sub_params" name="submode" value="params"
                         {% if submode == "params" or not submode %}checked{% endif %}>
                  <label for="sub_params">Проверка параметров</label>

                  <input type="radio" id="sub_compare" name="submode" value="compare"
                         {% if submode == "compare" %}checked{% endif %}>
                  <label for="sub_compare">Сравнение заказов</label>

                  <input type="radio" id="sub_sec" name="submode" value="security"
                         {% if submode == "security" %}checked{% endif %}>
                  <label for="sub_sec">Проверка ИБ</label>
                </div>
              </div>
              <!-- OVERPRICING CHECKBOX (only params) -->
              <div id="block-over" style="margin-top:12px;">
                <label style="display:flex; gap:10px; align-items:center; cursor:pointer; user-select:none;">
                  <input type="checkbox" id="id_over" name="over" style="width:18px; height:18px;">
                  <span style="font-weight:900;">Включить завышения</span>
                </label>
              </div>

              <!-- SINGLE ORDER (params/security) -->
              <div id="block-order-single" style="margin-top:14px;">
                <button type="button" class="btn" id="btnExcelNew">Загрузка заказа</button>
                <div class="pill" id="excelNewName"><b>Заказ:</b> <span class="muted">не выбран</span></div>
              </div>

              <!-- COMPARE (two orders) -->
              <div id="block-order-compare" style="margin-top:14px;">
                <button type="button" class="btn" id="btnExcelCompareNew">Новый заказ</button>
                <div class="pill" id="excelCompareNewName"><b>Новый:</b> <span class="muted">не выбран</span></div>

                <div class="row-gap"></div>

                <button type="button" class="btn" id="btnExcelCompareOld">Старый заказ</button>
                <div class="pill" id="excelCompareOldName"><b>Старый:</b> <span class="muted">не выбран</span></div>
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div class="right">
            <p class="section-title" style="align-self:flex-start;margin-bottom:0;">Режим проверки</p>
            <div class="mode" style="align-self:flex-start;">
              <input type="radio" id="mode_diag" name="mode" value="diagram"
                     {% if mode != "services" %}checked{% endif %}>
              <label for="mode_diag">Проверка диаграммы</label>

              <input type="radio" id="mode_services" name="mode" value="services"
                     {% if mode == "services" %}checked{% endif %}>
              <label for="mode_services">Проверка заказа</label>
            </div>

            <button type="submit" class="btn btn-primary" onclick="onStartClick()">
                Старт
            </button>
            <div id="calc-status" style="
                margin-top: 10px;
                color: white;
                font-weight: bold;
                display: none;
            ">
                Идёт расчёт…
            </div>

          </div>

        </div>

        <div class="out">
          <p class="section-title">Вывод</p>
          <div class="output-box">{% if output %}{{ output }}{% endif %}</div>
          {% if output %}
          <script>
              const status = document.getElementById("calc-status");
              if (status) {
                  status.style.display = "block";
                  status.textContent = "Расчёт окончен";
              }
          </script>
          {% endif %}

        </div>





  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // ---------- helpers ----------
      function byId(id) { return document.getElementById(id); }
      function show(el, yes) { if (el) el.style.display = yes ? "" : "none"; }
      function setRequired(el, yes) { if (el) el.required = !!yes; }
      function setPill(pillEl, file) {
        if (!pillEl) return;
        const span = pillEl.querySelector("span");
        if (!span) return;
        if (!file) { span.textContent = "не выбран"; span.className = "muted"; return; }
        span.textContent = file.name;
        span.className = "";
      }

      // ---------- mode radios ----------
      const modeDiag     = byId("mode_diag");
      const modeServices = byId("mode_services");

      // ---------- submode radios (order checks) ----------
      const subParams  = byId("sub_params");
      const subCompare = byId("sub_compare");
      const subSec     = byId("sub_sec");

      // ---------- blocks ----------
      const blockDiagram      = byId("block-diagram");
      const blockServices     = byId("block-services");
      const blockOrderSingle  = byId("block-order-single");   // один файл
      const blockOrderCompare = byId("block-order-compare");  // два файла
      const blockOver         = byId("block-over");           // галочка завышений

      // ---------- file inputs ----------
      const drawioInput  = byId("id_drawio");

      // новый заказ (всегда)
      const excelNewInput = byId("id_excel_new");

      // старый заказ (только compare)
      const excelOldInput = byId("id_excel_old");

      // ---------- buttons ----------
      const btnDrawio          = byId("btnDrawio");
      const btnExcelNew        = byId("btnExcelNew");
      const btnExcelCompareNew = byId("btnExcelCompareNew");
      const btnExcelCompareOld = byId("btnExcelCompareOld");

      // ---------- pills ----------
      const drawioName           = byId("drawioName");
      const excelNewName         = byId("excelNewName");
      const excelCompareNewName  = byId("excelCompareNewName");
      const excelCompareOldName  = byId("excelCompareOldName");

      // ---------- bind file dialog ----------
      if (btnDrawio && drawioInput) btnDrawio.addEventListener("click", () => drawioInput.click());
      if (btnExcelNew && excelNewInput) btnExcelNew.addEventListener("click", () => excelNewInput.click());
      if (btnExcelCompareNew && excelNewInput) btnExcelCompareNew.addEventListener("click", () => excelNewInput.click());
      if (btnExcelCompareOld && excelOldInput) btnExcelCompareOld.addEventListener("click", () => excelOldInput.click());

      // ---------- update pills ----------
      if (drawioInput) drawioInput.addEventListener("change", () => setPill(drawioName, drawioInput.files[0]));
      if (excelNewInput) excelNewInput.addEventListener("change", () => {
        const f = excelNewInput.files[0];
        setPill(excelNewName, f);
        setPill(excelCompareNewName, f);
      });
      if (excelOldInput) excelOldInput.addEventListener("change", () => setPill(excelCompareOldName, excelOldInput.files[0]));

      // ---------- main switcher ----------
      function applyMode() {
        const isServices = !!(modeServices && modeServices.checked);
        const isCompare  = !!(subCompare && subCompare.checked);
        const isParams   = !!(subParams && subParams.checked);

        // Диаграмма
        show(blockDiagram, !isServices);

        // Excel (заказ) — ВСЕГДА доступен
        show(blockServices, true);

        // Подрежимы — ТОЛЬКО в "Проверка заказа"
        const blockSubmodes = document.getElementById("block-submodes");
        show(blockSubmodes, isServices);

        // Поля заказа:
        // - диаграмма -> один заказ
        // - заказ/params, заказ/ИБ -> один заказ
        // - заказ/compare -> два заказа
        show(blockOrderSingle, !isServices || (isServices && !isCompare));
        show(blockOrderCompare, isServices && isCompare);

        // Галочка завышений — ТОЛЬКО заказ + параметры
        show(blockOver, isServices && isParams);

        // required
        setRequired(drawioInput, !isServices);
        setRequired(excelNewInput, true);                 // заказ нужен всегда
        setRequired(excelOldInput, isServices && isCompare);
      }


      // events
      if (modeDiag) modeDiag.addEventListener("change", applyMode);
      if (modeServices) modeServices.addEventListener("change", applyMode);

      if (subParams) subParams.addEventListener("change", applyMode);
      if (subCompare) subCompare.addEventListener("change", applyMode);
      if (subSec) subSec.addEventListener("change", applyMode);

      // стартовое применение
      applyMode();
    });
  </script>
  <script>
    function onStartClick() {
        const status = document.getElementById("calc-status");
        if (status) {
            status.style.display = "block";
            status.textContent = "Идёт расчёт…";
        }
    }
    </script>
</body>
</html>
